name: Merge Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment to deploy to
        options:
          - dev
          - test
          - model
          - prod
      version:
        required: true
        type: string

jobs:
  checkout_and_run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set Up Environment and Write to File
        run: |
          buildStartTime=$(date "+%Y-%m-%d %H:%M:%S.000")
          echo "Reading configuration from pipeline.properties"
          tempProps=$(<"pipeline.properties")
          echo "$tempProps"

          ucdComponentName=$(echo "$tempProps" | grep 'ucdComponentName' | cut -d'=' -f2)
          echo "$ucdComponentName"
          ucdApplicationName=$(echo "$tempProps" | grep 'ucdApplicationName' | cut -d'=' -f2)
          ucdProcessName=$(echo "$tempProps" | grep 'ucdProcessName' | cut -d'=' -f2)
          devRecipients=$(echo "$tempProps" | grep 'devRecipients' | cut -d'=' -f2)
          modelRecipients=$(echo "$tempProps" | grep 'modelRecipients' | cut -d'=' -f2)
          prodRecipients=$(echo "$tempProps" | grep 'prodRecipients' | cut -d'=' -f2)
          successRecipients=$(echo "$tempProps" | grep 'successRecipients' | cut -d'=' -f2)
          unitTest=$(echo "$tempProps" | grep 'unitTest' | cut -d'=' -f2)

          # Set Flags
          isDevelop=$(echo "$BRANCH_NAME" | grep -q 'dev/' && echo true || echo false)
          isDevelop2=$(echo "$BRANCH_NAME" | grep -q 'dev-02/' && echo true || echo false)
          isTest=$(echo "$BRANCH_NAME" | grep -q 'test/' && echo true || echo false)
          isProd2=$(echo "$BRANCH_NAME" | grep -q 'prod2/' && echo true || echo false)
          isModel=$(echo "$BRANCH_NAME" | grep -q 'release/' && echo true || echo false)
          isProd=$(echo "$BRANCH_NAME" | grep -q 'master' && echo true || echo false)

          if [ "$isProd" = true ]; then
            ucdEnv='prod'
            isCRRequired=true
            isPRRequired=true
            recipients="$prodRecipients,$globalProdRecipients"
          elif [ "$isProd2" = true ]; then
            ucdEnv='prod2'
            isCRRequired=false
            isPRRequired=false
            recipients="$prodRecipients,$globalProdRecipients"
          elif [ "$isModel" = true ]; then
            ucdEnv='model'
            isCRRequired=true
            isPRRequired=true
            recipients="$modelRecipients,$globalModelRecipients"
          elif [ "$isTest" = true ]; then
            ucdEnv='test'
            isCRRequired=true
            isTestCaseRequired=true
            isPRRequired=true
            recipients="$modelRecipients,$globalTestRecipients"
          elif [ "$isDevelop" = true ]; then
            ucdEnv='dev'
            recipients="$devRecipients,$globalDevRecipients"
          elif [ "$isDevelop2" = true ]; then
            ucdEnv='dev-02'
            recipients="$devRecipients,$globalDev02Recipients"
          fi

          envName=$(echo "$ucdEnv" | tr '[:lower:]' '[:upper:]')
          unique_id=$(date '+%s')
          ucdVersion="${ucdComponentName}:${ucdEnv}-${unique_id}-v1-${GITHUB_RUN_NUMBER}"
          commitId=$(git rev-parse HEAD)
          echo "commitId: $commitId"
          gitLog=$(git log -n 1 --pretty=format:%s)
          echo "gitLog: $gitLog"
          echo "$tempProps"
          echo "$ucdComponentName"
          echo "ucdComponentName=${ucdComponentName}" >> $GITHUB_ENV
          echo "ucdVersion=${ucdVersion}" >> $GITHUB_ENV
      - name: Debug - Print tempProps
        run: echo "$tempProps"

      - name: Debug - Print ucdComponentName and ucdVersion
        run: |
          echo "ucdComponentName: $ucdComponentName"
          echo "ucdVersion: $ucdVersion"
      - name: Archive Code
        uses: actions/upload-artifact@v3
        with:
          name: source-code
          path: .  # I want to archive the entire directory

  build:
    runs-on: ubuntu-latest
    needs: [checkout_and_run]
    steps:
      - name: Download Code
        uses: actions/download-artifact@v3
        with:
          name: source-code
          path: .  # I want to download to the current directory
      - name: Read ucdComponentName and ucdVersion from File
        run: |
          source $GITHUB_ENV
          echo "ucdComponentName: $ucdComponentName"
          echo "ucdVersion: $ucdVersion"
      # Other steps for build job...

  UCDPublish:
    runs-on: ubuntu-latest
    needs: [checkout_and_run]
    steps:
      - name: Download Code
        uses: actions/download-artifact@v3
        with:
          name: source-code
          path: .  # I want to download to the current directory
      - name: Read ucdComponentName and ucdVersion from File
        run: |
          source $GITHUB_ENV
          echo "ucdComponentName: $ucdComponentName"
          echo "ucdVersion: $ucdVersion"
      # Other steps for UCDPublish job...
